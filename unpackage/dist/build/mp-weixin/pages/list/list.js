"use strict";const e=require("../../common/vendor.js"),t=require("../../stores/counter.js"),a=require("../../request/index.js"),o=require("../../utils/uuid.js");if(!Array){(e.resolveComponent("van-button")+e.resolveComponent("van-card")+e.resolveComponent("van-loading")+e.resolveComponent("van-tab")+e.resolveComponent("van-tabs"))()}const n={__name:"list",setup(n){const r=t.Store(),s=e.index.getStorageSync("sessionCookie");let d=!0;e.onPullDownRefresh((()=>{d=!0,0==c?(i=1,m.value=[],b(1)):1==c&&(l=1,v.value=[],y(1))})),e.onTabItemTap((e=>{d=!0,m.value=[],b(1)}));let i=1,l=1;const u=e.ref(!1);e.onReachBottom((()=>{console.log(1),0==c?(i++,b(i)):1==c&&(l++,y(l))}));let c=0;const p=e=>{console.log(e.detail.index),c=e.detail.index,d=!0,0==c?(m.value=[],b(1)):1==c&&(v.value=[],y(1))},g=e.ref(!1),m=e.ref([]),b=async e=>{d&&await a.request({url:"feedOrderCenter/list/page",method:"POST",data:{cart_id:0,current:e,id:0,isDelete:0,pageSize:10,running_user_id:0,sortField:"",sortOrder:"",state:0,user_id:0}}).then((e=>{console.log("订单",e.data),0==e.data.data.records.length?d=!1:(u.value=!0,setTimeout((()=>{u.value=!1,m.value.push(...e.data.data.records)}),1e3))}))},v=e.ref([]),y=async e=>{d&&a.request({url:"submitOrder/my/list/page/vo",method:"POST",header:{"content-type":"application/json",Cookie:s},data:{current:e,id:"",isDelete:0,order_state:0,pageSize:10,schoolId:0,sortField:"",sortOrder:"",submit_index:0,userId:0}}).then((e=>{console.log("其他订单",e.data),0==e.data.data.records.length?d=!1:(u.value=!0,setTimeout((()=>{u.value=!1,v.value.push(...e.data.data.records)}),1e3))}))};e.index.onSocketClose((e=>{console.log("当前连接已关闭")})),e.onHide((()=>{e.index.closeSocket()}));const _=e=>{let t=new Date(e);return(parseInt(t.getMonth())+1).toString()+"月"+t.getDate()+"日"+t.getHours()+"时"+t.getMinutes()+"分"};return(t,n)=>({a:e.f(m.value,((t,n,i)=>({a:e.t(_(t.createTime)),b:e.t(_(t.delivery_time)),c:e.o((a=>((t,a)=>{let o={cartId:t,state:a};e.index.navigateTo({url:`/subpages/pay/pay?orderDetail=${encodeURIComponent(JSON.stringify(o))}`})})(t.cart_id,t.state+1)),n),d:e.o((n=>(async(t,n)=>{await a.request({url:"feedOrderCenter/update",method:"POST",header:{"content-type":"application/json",Cookie:s},data:{cart_id:t,id:0,running_user_id:r.userId}}).then((t=>{if(0==t.data.code){g.value=!0,d=!0,m.value=[],b(1),setTimeout((()=>{g.value=!1}),500);let t=null;a.request({url:"chat/selectChatID_A_And_B",method:"POST",data:{userA:r.userId,userB:n},header:{"content-type":"application/json",Cookie:s}}).then((async a=>{console.log(a.data),t=0==a.data.code?a.data.data:o.uuid(),await e.index.connectSocket({url:`ws://39.99.231.129:8121/api/websocket/${t}`,complete:()=>{}}),e.index.onSocketOpen((e=>{console.log("websocket连接已打开")})),e.index.onSocketClose((e=>{console.log("websocket 打开失败 请检查!")}));let s={chat_id:t,user_id:r.userId,user_img:r.userInfo.userAvatar,user_name:r.userInfo.userName,content:"你好,我已接单。",content_type:0,user_other:n};console.log(s),setTimeout((()=>{e.index.sendSocketMessage({data:JSON.stringify(s)})}),1e3)}))}else(t.data.code=40101)&&e.index.redirectTo({url:"/subpages/takeaway/takeaway"})}))})(t.cart_id,t.user_id)),n),e:"14bfbae0-3-"+i+",14bfbae0-2-"+i,f:e.p({type:"primary",disabled:t.user_id==e.unref(r).userId}),g:"14bfbae0-2-"+i+",14bfbae0-1",h:e.p({price:t.money,title:t.delivery_address,thumb:t.user_head_img,lazyLoad:!0}),i:n}))),b:e.p({color:"#1989fa",type:"spinner"}),c:u.value,d:e.p({title:"外卖订单"}),e:e.f(v.value,((t,n,i)=>({a:e.t(JSON.parse(t.content).explain.replace(/null/g,"")),b:e.t(_(JSON.parse(t.content).expectTime)),c:e.o((n=>(async(t,n)=>{await a.request({url:"submitOrder/update/togoQiang",method:"POST",header:{"content-type":"application/json",Cookie:s},data:{id:t,isDelete:0,order_state:1}}).then((t=>{if(0==t.data.code){g.value=!0,d=!0,v.value=[],y(1),setTimeout((()=>{g.value=!1}),500);let t=o.uuid();e.index.connectSocket({url:`ws://39.99.231.129:8121/api/websocket/${t}`,complete:()=>{}}),e.index.onSocketOpen((e=>{console.log("websocket连接已打开")})),e.index.onSocketClose((e=>{console.log("websocket 打开失败 请检查!")}));let a={chat_id:t,user_id:r.userId,user_img:r.userInfo.userAvatar,user_name:r.userInfo.userName,content:"你好,我已接单。",content_type:0,user_other:n};console.log(a),e.index.sendSocketMessage({data:JSON.stringify(a)})}else(t.data.code=40101)&&e.index.redirectTo({url:"/subpages/takeaway/takeaway"})}))})(t.id,t.userId)),n),d:"14bfbae0-7-"+i+",14bfbae0-6-"+i,e:e.p({type:"primary",disabled:t.userId==e.unref(r).userId}),f:"14bfbae0-6-"+i+",14bfbae0-5",g:e.p({title:JSON.parse(t.content).className,price:JSON.parse(t.content).order_money,lazyLoad:!0}),h:n}))),f:e.p({color:"#1989fa",type:"spinner"}),g:u.value,h:e.p({title:"其他订单"}),i:e.o(p),j:e.p({animated:!0,swipeable:!0,sticky:!0}),k:g.value})}};wx.createPage(n);
