"use strict";const e=require("../../common/vendor.js"),o=require("../../stores/counter.js"),a=require("../../request/index.js"),t=require("../../utils/uuid.js");if(!Array){(e.resolveComponent("van-nav-bar")+e.resolveComponent("van-field")+e.resolveComponent("van-card")+e.resolveComponent("van-button"))()}const n={__name:"pay",setup(n){const r=e.index.getStorageSync("sessionCookie"),l=o.Store(),s=e.ref({}),d=e.ref(!0);e.onLoad((async e=>{"goodsStore"in e&&(s.value=JSON.parse(decodeURIComponent(e.goodsStore)),console.log(s.value)),"orderDetail"in e&&(s.value=JSON.parse(decodeURIComponent(e.orderDetail)),console.log(s.value),d.value=!1),console.log(d.value),c()}));const u=e.ref([]),c=async()=>{await a.request({url:"userCart/my/list/page/vo",method:"POST",header:{"content-type":"application/json",Cookie:r},data:{cartId:s.value.cartId,current:1,id:0,isDelete:0,num:0,pageSize:10,schoolId:s.value.schoolId,schoolStoreFeedId:0,sortField:"",sortOrder:"",state:s.value.state||0,sum_money:0,userId:0}}).then((e=>{u.value=e.data.data||null,console.log("购物车列表",u.value)}))},i=e.computed((()=>{let e=0;for(let o of u.value)e+=o.num*o.feeds.new_money;return e+2})),p=async(e,o)=>{console.log(o),await u.value.forEach((t=>{t.schoolStoreFeedId===o.schoolStoreFeedId&&t.num+e>0&&(t.num+=e,a.request({url:"userCart/update/by/Cart/Id",method:"POST",data:{cartId:s.value.cartId,num:t.num,schoolId:s.value.schoolId,schoolStoreFeedId:parseInt(t.schoolStoreFeedId),sum_money:t.num*o.feeds.new_money,userId:0},header:{"content-type":"application/json",Cookie:r}}).then((e=>{console.log("修改购物车商品消息",e.data),c()})))}))},v=e.ref(""),m=e=>{v.value=e.detail.value.trim(),0==v.value.length&&(g.value=!0,setTimeout((()=>{g.value=!1}),500))},g=e.ref(!1),y=e.ref(""),f=e=>{y.value=e.detail.trim()},h=async()=>{v.value.length>0?await a.request({url:"userCart/update/state/by/CartIdAndUserId",method:"POST",header:{"content-type":"application/json",Cookie:r},data:{cartId:s.value.cartId,state:1,address:v.value,content:y.value}}).then((o=>{console.log("订单状态",o),0===o.data.code&&(e.index.removeStorageSync(s.value.schoolId.toString()),e.index.removeStorageSync(s.value.storeName),setTimeout((()=>{e.index.switchTab({url:"/pages/index/index"})}),1500))})):(g.value=!0,await setTimeout((()=>{g.value=!1}),500))},I=()=>{e.index.navigateBack()},S=async()=>{let o;console.log("微信支付Test"),console.log(l.userInfo.mpOpenId);try{o=await a.request({url:"/pay/returnparam",method:"GET",data:{openid:l.userInfo.mpOpenId,price:1,goodsid:t.uuid(),title:"微信测试"}}),console.log("returnparam接口成功",o.data);try{e.index.requestPayment({timeStamp:o.data.timeStamp,nonceStr:o.data.nonceStr,package:o.data.package,signType:o.data.signType,paySign:o.data.paySign,appId:o.data.appid,success(e){console.log("拉起payment success",e),console.log(e)},fail(e){console.log("拉起payment fail",e),console.log(e)}})}catch(n){console.error("请求失败",n)}}catch(r){console.error("请求失败",r)}console.log("无论请求成功还是失败后的处理逻辑",o)};return(o,a)=>e.e({a:e.o(I),b:e.p({leftText:"返回",leftArrow:!0,safeAreaInsetTop:!1}),c:e.o(m),d:e.p({value:u.value[0].address,placeholder:"请输入校内送货地址",required:!0,readonly:!d.value,autoFocus:!0}),e:e.t(s.value.storeName),f:e.t(s.value.cartId),g:e.f(u.value,((o,a,t)=>e.e(d.value?{a:e.o((e=>p(-1,o)),a),b:e.t(o.num),c:e.o((e=>p(1,o)),a)}:{d:e.t(o.num)},{e:a,f:"769789ea-2-"+t,g:e.p({price:o.sum_money,title:o.feeds.feed_name,thumb:o.feeds.url})}))),h:d.value,i:e.o(f),j:e.p({label:"备注:",type:"textarea",value:u.value[0].content,placeholder:"请输入50字以内备注",autosize:!0,readonly:!d.value,maxlength:50}),k:e.p({label:"跑腿酬金:",type:"text",value:"2元",readonly:!0}),l:d.value},d.value?{m:e.t(e.unref(i)),n:e.o(S),o:e.p({round:!0,type:"info",color:"linear-gradient(to right, #ff5500, #ff0000)"}),p:e.o(h),q:e.p({round:!0,type:"info",color:"linear-gradient(to right, #ff5500, #ff0000)"})}:{},{r:g.value})}};wx.createPage(n);
