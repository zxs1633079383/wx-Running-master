"use strict";const e=require("../../common/vendor.js"),a=require("../../stores/counter.js"),t=require("../../request/index.js"),o=require("../../utils/uuid.js");if(!Array){(e.resolveComponent("van-icon")+e.resolveComponent("van-nav-bar")+e.resolveComponent("van-button")+e.resolveComponent("van-sidebar-item")+e.resolveComponent("van-sidebar")+e.resolveComponent("van-card")+e.resolveComponent("van-empty")+e.resolveComponent("van-popup"))()}const n={__name:"detail",setup(n){const r=a.Store(),s=e.index.getStorageSync("sessionCookie"),l=e.ref(null),d=e.ref({});e.onLoad((async a=>{"params"in a&&(d.value=JSON.parse(decodeURIComponent(a.params))),console.log(d.value),e.index.getStorageSync(d.value.id)||(l.value=o.uuid(),e.index.setStorageSync(d.value.id,l.value)),g(),await r.getClassTitle({category1Id:parseInt(d.value.category1Id),category2Id:parseInt(d.value.id),category3Name:"",category3id:0,current:0,feed_name:"",feed_state:0,id:0,isDelete:0,pageSize:0,sortField:"",sortOrder:"",state:0}),await setTimeout((()=>{r.getStoreDetail({category1Id:parseInt(d.value.category1Id),category2Id:parseInt(d.value.id),category3Name:"",category3id:r.classData[0].category3id,current:1,feed_name:"",feed_state:0,id:0,isDelete:0,pageSize:5,sortField:"",sortOrder:"",state:0})}),1500)}));const i=async()=>{let a=[];for(let e of p)a.push(e),console.log("缓存id为： "+e+"  商铺为： "+d.value.storeName);e.index.setStorageSync(d.value.storeName,a),e.index.switchTab({url:"/pages/index/index"})},u=e.computed((()=>r.storeDetailData));console.log(u.value);const c=e.computed((()=>r.classData));console.log(c.value);const m=e.ref([]),g=async()=>{await t.request({url:"userCart/my/list/page/vo",method:"POST",header:{"content-type":"application/json",Cookie:s},data:{cartId:e.index.getStorageSync(d.value.id),current:1,id:0,isDelete:0,num:0,pageSize:10,schoolId:parseInt(d.value.category1Id),schoolStoreFeedId:0,sortField:"",sortOrder:"",state:0,sum_money:0,userId:0}}).then((e=>{m.value=e.data.data||null}))},v=e.ref(!1),p=new Set,y=async(a,o)=>{console.log(a,o),await m.value.forEach((n=>{n.schoolStoreFeedId===o.schoolStoreFeedId&&n.num+a>0&&(n.num+=a,t.request({url:"userCart/update/by/Cart/Id",method:"POST",data:{cartId:e.index.getStorageSync(d.value.id),num:n.num,schoolId:parseInt(d.value.category1Id),schoolStoreFeedId:parseInt(n.schoolStoreFeedId),sum_money:n.num*o.feeds.new_money,userId:0},header:{"content-type":"application/json",Cookie:s}}).then((e=>{console.log("修改购物车商品消息",e.data),g()})))}))},I=e.ref(!1),S=()=>{I.value=!0},h=()=>{I.value=!1},f=["热销中","促销中","已售空"];return(a,o)=>e.e({a:d.value.imageUrl,b:e.p({name:"search"}),c:e.p({name:"phone-o"}),d:e.p({name:"share-o"}),e:e.o(i),f:e.p({leftArrow:!0,safeAreaInsetTop:!1}),g:d.value.imageUrl,h:e.t(d.value.storeName),i:e.p({icon:"plus",type:"default",size:"mini"}),j:e.t(d.value.score),k:e.t(d.value.delivery_time),l:e.t(d.value.address),m:e.f(e.unref(c),((a,t,o)=>({a:e.o((e=>(async e=>{await r.getStoreDetail({category1Id:d.value.category1Id,category2Id:parseInt(d.value.id),category3Name:"",category3id:e,current:1,feed_name:"",feed_state:0,id:0,isDelete:0,pageSize:5,sortField:"",sortOrder:"",state:0})})(a.category3id)),t),b:t,c:"265b757e-6-"+o+",265b757e-5",d:e.p({title:a.category3Name})}))),n:e.f(e.unref(u),((a,o,n)=>e.e({a:0===a.state},0===a.state?{b:e.o((o=>(async a=>{e.index.getStorageSync(d.value.storeName)&&(console.log("缓存存在 当前商铺"),e.index.getStorageSync(d.value.storeName).forEach((e=>{p.add(e)}))),console.log(a),v.value=!0,p.has(a.id)?y(1,{schoolStoreFeedId:a.id,feeds:{new_money:a.new_money}}):(p.add(a.id),await t.request({url:"userCart/add",method:"POST",data:{cartId:e.index.getStorageSync(d.value.id),num:1,schoolId:parseInt(a.category1Id),schoolStoreFeedId:parseInt(a.id),sum_money:a.new_money},header:{"content-type":"application/json",Cookie:s}}).then((e=>{console.log("添加到购物车消息",e),g()}))),await setTimeout((()=>v.value=!1),1e3)})(a)),a.id),c:"265b757e-7-"+n,d:e.p({tag:f[a.feed_state],price:a.new_money,originPrice:a.old_money,desc:"已售出"+a.count+"份",title:a.feed_name,thumb:a.url})}:{},{e:a.id}))),o:0!=m.value.length?1:"",p:null==m.value||0===m.value.length},null==m.value||0===m.value.length?{}:{q:e.t(m.value.length)},{r:e.o(S),s:null!=m.value?1:"",t:e.o((a=>(a=>{if(a>0){let a={cartId:e.index.getStorageSync(d.value.id),schoolId:parseInt(d.value.category1Id),storeName:d.value.storeName};e.index.navigateTo({url:`/subpages/pay/pay?goodsStore=${encodeURIComponent(JSON.stringify(a))}`})}})(null!=m.value?m.value.length:0))),v:e.o(h),w:e.p({size:"50rpx",name:"cross"}),x:null==m.value||0==m.value.length},null==m.value||0==m.value.length?{y:e.p({image:"https://img.yzcdn.cn/vant/custom-empty-image.png",description:"请选择商品"})}:{z:e.f(m.value,((a,t,o)=>({a:e.o((e=>y(-1,a)),t),b:"265b757e-12-"+o+",265b757e-11-"+o,c:e.t(a.num),d:e.o((e=>y(1,a)),t),e:"265b757e-13-"+o+",265b757e-11-"+o,f:e.o((t=>(async a=>{await r.clearGood({cartId:e.index.getStorageSync(d.value.id),feedId:a}),g()})(a.schoolStoreFeedId)),t),g:"265b757e-14-"+o+",265b757e-11-"+o,h:t,i:"265b757e-11-"+o+",265b757e-8",j:e.p({price:a.sum_money,title:a.feeds.feed_name,thumb:a.feeds.url})}))),A:e.p({size:"mini"}),B:e.p({size:"mini"}),C:e.p({size:"mini"})},{D:e.p({show:I.value,position:"bottom",customStyle:"height: 60%;",round:!0,overlay:I.value}),E:v.value},(v.value,{}))}},r=e._export_sfc(n,[["__scopeId","data-v-265b757e"]]);wx.createPage(r);
