"use strict";const e=require("../../common/vendor.js"),o=require("../../stores/counter.js"),t=require("../../request/index.js"),n=require("../../utils/uuid.js");if(!Array){(e.resolveComponent("van-image")+e.resolveComponent("van-icon")+e.resolveComponent("van-uploader")+e.resolveComponent("van-button")+e.resolveComponent("van-overlay"))()}const a={__name:"conversation",setup(a){const s=o.Store(),r=e.index.getStorageSync("sessionCookie");let l=null,c=null;const u=e.ref([]),i=e=>{console.log(e),d(e.detail.file)},d=(o,t)=>{console.log(o),e.index.getFileSystemManager().readFile({filePath:o[0].url,encoding:"base64",success(e){p.value=e.data,console.log(e.data),y(1)},fail(e){console.log("读取失败")}})};e.onBackPress((()=>{console.log(1)})),e.onLoad((async o=>{"otherId"in o&&(l=o.otherId),console.log(s.userInfo),await t.request({url:"chat/selectChatID_A_And_B",method:"POST",data:{userA:s.userId,userB:l},header:{"content-type":"application/json",Cookie:r}}).then((o=>{console.log(o.data),0==o.data.code?(c=o.data.data,v()):c=n.uuid(),e.index.connectSocket({url:`ws://39.99.231.129:8121/api/websocket/${c}`,complete:()=>{}}),e.index.onSocketOpen((e=>{console.log("websocket连接已打开")})),e.index.onSocketClose((e=>{console.log("websocket 打开失败 请检查!")}))}))})),e.onReady((()=>{S()}));const p=e.ref(""),g=e=>{p.value=e.detail.value.trim()},h=e.ref([]),v=async()=>{t.request({url:"chat/toChatInnerByUserA_AndUserB",method:"POST",data:{userA:s.userId,userB:l},header:{"content-type":"application/json",Cookie:r}}).then((e=>{console.log(e.data.data),h.value=e.data.data}))},m=e.ref(!1),x=e.ref(""),_=e=>{m.value=!0,x.value=e},y=e=>{let o={chat_id:c,user_id:s.userId,user_img:s.userInfo.userAvatar,user_name:s.userInfo.userName,content:p.value,content_type:e,user_other:l};0!=p.value.length&&f(JSON.stringify(o)),p.value=""},f=o=>{console.log(o),e.index.sendSocketMessage({data:o})};e.index.onSocketMessage((e=>{console.log("后台返回",JSON.parse(e.data)),h.value.push(JSON.parse(e.data)),S()})),e.index.onSocketClose((e=>{console.log("当前连接已关闭")}));const S=()=>{e.index.createSelectorQuery().select("#bottom").boundingClientRect((o=>{console.log(o),e.index.pageScrollTo({scrollTop:o.bottom,duration:300})})).exec()};return(o,t)=>({a:e.f(h.value,((o,t,n)=>e.e({a:o.user_id==e.unref(s).userId},o.user_id==e.unref(s).userId?e.e({b:0==o.content_type},0==o.content_type?{c:e.t(o.content)}:{d:e.o((e=>_(o.content)),t),e:"5a6be478-0-"+n,f:e.p({width:"180rpx",height:"180rpx",src:o.content})},{g:"5a6be478-1-"+n,h:e.p({round:!0,width:"80rpx",height:"80rpx",src:o.user_img})}):e.e({i:"5a6be478-2-"+n,j:e.p({round:!0,width:"80rpx",height:"80rpx",src:o.user_img}),k:0==o.content_type},0==o.content_type?{l:e.t(o.content)}:{m:e.o((e=>_(o.content)),t),n:"5a6be478-3-"+n,o:e.p({width:"180rpx",height:"180rpx",src:o.content})}),{p:t}))),b:e.o(g),c:p.value,d:e.p({size:"60rpx",name:"photo-o"}),e:e.o(i),f:e.p({maxSize:8388608,value:u.value,multiple:!0,accept:"image/*"}),g:e.o((e=>y(0))),h:e.p({size:"small",type:"primary"}),i:x.value,j:e.o((e=>m.value=!1)),k:e.p({show:m.value})})}};wx.createPage(a);
